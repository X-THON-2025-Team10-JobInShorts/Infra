---
# ==========================================
# 1. 공통 작업 (모든 노드에 적용)
# ==========================================
- name: Common Setup for All Nodes
  hosts: all
  become: true
  tasks:
    - name: Disable Swap (Kubernetes 필수)
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Remove Swap from fstab (재부팅해도 꺼지게 설정)
      replace:
        path: /etc/fstab
        regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
        replace: '# \1'

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

# ==========================================
# 2. 마스터 노드 설정
# ==========================================
- name: Setup Master Node
  hosts: master
  become: true
  tasks:
    - name: Install k3s Master
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for k3s token to be generated
      wait_for:
        path: /var/lib/rancher/k3s/server/node-token

    - name: Read Node Token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: node_token_base64

    - name: Save Token to Variable (워커 노드에 전달하기 위함)
      set_fact:
        k3s_token: "{{ node_token_base64.content | b64decode | trim }}"

    - name: Get Master Private IP
      set_fact:
        master_ip: "{{ ansible_default_ipv4.address }}" # ens5 IP 자동 감지

    - name: Create .kube directory
      file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy config file to user home
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /home/ubuntu/.kube/config
        remote_src: yes
        owner: ubuntu
        group: ubuntu
        mode: '0600'

# ==========================================
# 3. 워커 노드 설정
# ==========================================
- name: Setup Worker Node
  hosts: worker
  become: true
  tasks:
    - name: Install k3s Agent & Join Cluster
      shell: >
        curl -sfL https://get.k3s.io | K3S_URL=https://{{ hostvars['master-node']['master_ip'] }}:6443 
        K3S_TOKEN={{ hostvars['master-node']['k3s_token'] }} 
        sh -s - --flannel-iface={{ flannel_iface }}
      args:
        creates: /usr/local/bin/k3s-agent

    - name: Label Worker Node (Running on Master)
      delegate_to: master-node
      command: >
        kubectl label nodes {{ ansible_hostname }} node-role.kubernetes.io/ai-worker= --overwrite
      register: label_result
      retries: 5
      delay: 10
      until: label_result.rc == 0
